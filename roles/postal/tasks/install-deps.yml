# - name: Add Ruby repo.
#   apt_repository:
#     repo: ppa:brightbox/ruby-ng

- name: Install Ruby & dependencies.
  apt:
    state: latest
    name:
      - build-essential
      - default-libmysqlclient-dev
      - nodejs
      # - python3-pip
      # - python3-setuptools
      - "ruby{{ ruby_version }}"
      - "ruby{{ ruby_version }}-dev"
      - yq
    update_cache: yes

# - name: Install "yq" for parsing YAML in Bash.
#   pip:
#     name: yq

- name: Install system wide gem dependencies.
  command: 'bash -lc "gem install {{item}}"'
  with_items:
    - bundler
    - procodile

- name: Allow Ruby to bind to ports.
  capabilities:
    path: "/usr/bin/ruby{{ ruby_version }}"
    capability: cap_net_bind_service=+ep
    state: present

# TODO - better ansible 
- name: dependencies docker-install
  command: 'sudo apt-get install ca-certificates curl gnupg'

- name: keyrings
  ansible.builtin.command: 
    cmd: sudo install -m 0755 -d /etc/apt/keyrings

- name: keyrings
  ansible.builtin.shell: 
    cmd: curl -fsSL https://download.docker.com/linux/debian/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    creates: /etc/apt/keyrings/docker.gpg

- name: keyrings
  ansible.builtin.command: 
    cmd: sudo chmod a+r /etc/apt/keyrings/docker.gpg

- name: repo
  ansible.builtin.command: 
    cmd: 'echo  \
  "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian \
  "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \
  /usr/bin/sudo tee /etc/apt/sources.list.d/docker.list > /dev/null'

- name: Add docker repository into sources list
  ansible.builtin.apt_repository:
    repo: deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian  bookworm stable
    state: present
    filename: docker

- name: Packages
  apt:
    state: latest
    update_cache: yes
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
- name: alias from docker-compose to docker compose 
  copy:
    content: docker compose "$@"
    dest: /bin/docker-compose
    mode: '0755'